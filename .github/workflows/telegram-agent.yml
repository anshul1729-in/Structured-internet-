name: Telegram Agent (Issue -> PR)

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  issue_to_pr:
    if: startsWith(github.event.issue.title, 'Agent task:')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (OpenClaw needs 22+)
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install OpenClaw CLI
        run: npm install -g openclaw@latest

      - name: Write OpenClaw config (JSON5)
        run: |
          cat > "$RUNNER_TEMP/openclaw.json5" <<'JSON5'
          {
            agents: {
              defaults: {
                workspace: "${GITHUB_WORKSPACE}",
                repoRoot: "${GITHUB_WORKSPACE}",
                skipBootstrap: true,
                sandbox: { mode: "off" },

                // Use a specific tool-capable OpenRouter model
                models: {
                  "openrouter/qwen/qwen3-coder:free": {}
                },
                model: {
                  primary: "openrouter/qwen/qwen3-coder:free"
                }
              }
            },

            // Tool policy: ONLY file edits. No exec/web/browser/etc.
            tools: {
              allow: ["read", "write", "edit"],
              deny: ["group:runtime", "group:web", "group:ui", "group:messaging", "group:automation", "group:nodes"]
            }
          }
          JSON5

      - name: Debug effective sandbox/tool policy
        env:
          OPENCLAW_CONFIG_PATH: ${{ runner.temp }}/openclaw.json5
          OPENCLAW_HOME: ${{ runner.temp }}/openclaw-home
          OPENCLAW_STATE_DIR: ${{ runner.temp }}/openclaw-state
        run: |
          openclaw sandbox explain --json || true

      - name: Build OpenClaw prompt
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python - <<'PY'
          import os, pathlib
          title = os.environ.get("ISSUE_TITLE","")
          body  = os.environ.get("ISSUE_BODY","")

          prompt = f"""
          You are an AI coding agent operating inside a Git repo workspace.

          IMPORTANT:
          - You MUST use the tools: read, edit, write.
          - Start by reading src/App.jsx.
          - Then EDIT/WRITE src/App.jsx to implement the feature (do not just describe steps).
          - No new dependencies.

          TASK:
          {title}

          DETAILS FROM ISSUE:
          {body}

          IMPLEMENTATION REQUIREMENTS:
          - Add a Dark/Light mode toggle.
          - Default = Dark (keep current look as Dark).
          - Persist theme in localStorage (remember after refresh).
          - Add a small toggle button in the header (near navigation).
          - Keep it responsive on mobile layout too.
          - After edits, reply with a short summary of files changed.
          """.strip()

          path = pathlib.Path(os.environ["RUNNER_TEMP"]) / "prompt.txt"
          path.write_text(prompt + "\n", encoding="utf-8")
          print("Wrote", path)
          PY

      - name: Run OpenClaw agent to implement the change
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENCLAW_CONFIG_PATH: ${{ runner.temp }}/openclaw.json5
          OPENCLAW_HOME: ${{ runner.temp }}/openclaw-home
          OPENCLAW_STATE_DIR: ${{ runner.temp }}/openclaw-state
        run: |
          openclaw agent --local --json --verbose full --timeout 600 \
            --message "$(cat "$RUNNER_TEMP/prompt.txt")" \
            | tee "$RUNNER_TEMP/openclaw_output.json"

      - name: Show whether tools were used (quick debug)
        run: |
          python - <<'PY'
          import json, pathlib
          p = pathlib.Path("${RUNNER_TEMP}") / "openclaw_output.json"
          if not p.exists():
            print("No openclaw_output.json found")
            raise SystemExit(0)
          try:
            data = json.loads(p.read_text(encoding="utf-8"))
          except Exception as e:
            print("Could not parse JSON:", e)
            print(p.read_text(encoding="utf-8")[:2000])
            raise SystemExit(0)

          # Best-effort: search for tool names in the JSON payload
          s = json.dumps(data)
          hits = [t for t in ["read","edit","write","apply_patch","exec","web_search","browser"] if t in s]
          print("Tool keywords present in output:", hits)
          PY

      - name: Ensure agent made changes
        run: |
          if git diff --quiet; then
            echo "âŒ OpenClaw did not change any files."
            echo "Hint: open Actions logs and check the OpenClaw output + sandbox explain."
            exit 1
          fi

      - name: Install deps
        run: npm ci

      - name: Build (must pass)
        run: npm run build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Agent: implement task #${{ github.event.issue.number }}"
          title: "Agent PR for issue #${{ github.event.issue.number }}"
          body: |
            This PR was created automatically from issue #${{ github.event.issue.number }}.
            OpenClaw ran in GitHub Actions with OpenRouter.
          branch: agent/issue-${{ github.event.issue.number }}
          delete-branch: true
