name: Telegram Agent (Issue -> PR)

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  issue_to_pr:
    if: startsWith(github.event.issue.title, 'Agent task:')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (OpenClaw needs 22+)
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install OpenClaw CLI
        run: npm install -g openclaw@latest

      - name: Write OpenClaw config (JSON5)
        run: |
          cat > "$RUNNER_TEMP/openclaw.json5" <<JSON5
          {
            agents: {
              defaults: {
                workspace: "${GITHUB_WORKSPACE}",
                repoRoot: "${GITHUB_WORKSPACE}",
                skipBootstrap: true,
                sandbox: { mode: "off" },
                model: { primary: "openrouter/free" }
              }
            },
            tools: {
              profile: "coding",
              deny: ["group:web","group:ui","group:messaging","group:automation","group:nodes"]
            }
          }
          JSON5

      - name: Build OpenClaw prompt
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python - <<'PY'
          import os, pathlib
          title = os.environ.get("ISSUE_TITLE","")
          body  = os.environ.get("ISSUE_BODY","")
          prompt = f"""
          You are editing a React 18 + Webpack app.

          TASK:
          {title}

          DETAILS FROM ISSUE:
          {body}

          IMPLEMENTATION REQUIREMENTS (IMPORTANT):
          - Implement a Dark/Light mode toggle.
          - Default = Dark (keep current look as Dark).
          - Persist choice in localStorage (remember after refresh).
          - Only change what’s necessary (prefer editing src/App.jsx since styles are inline there).
          - Do NOT add new dependencies.
          - Add a small toggle button in the header (near navigation).
          - Keep it responsive (works on mobile layout too).
          - After edits, reply with a short summary of what files you changed.
          """
          path = pathlib.Path(os.environ["RUNNER_TEMP"]) / "prompt.txt"
          path.write_text(prompt.strip() + "\n", encoding="utf-8")
          print("Wrote", path)
          PY

      - name: Run OpenClaw agent to implement the change
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENCLAW_CONFIG_PATH: ${{ runner.temp }}/openclaw.json5
          OPENCLAW_HOME: ${{ runner.temp }}/openclaw-home
        run: |
          openclaw agent --local --json --verbose full --timeout 600 \
            --message "$(cat "$RUNNER_TEMP/prompt.txt")" \
            | tee "$RUNNER_TEMP/openclaw_output.json"

      - name: Ensure agent made changes
        run: |
          if git diff --quiet; then
            echo "❌ OpenClaw did not change any files."
            exit 1
          fi

      - name: Install deps
        run: npm ci

      - name: Build (must pass)
        run: npm run build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Agent: implement task #${{ github.event.issue.number }}"
          title: "Agent PR for issue #${{ github.event.issue.number }}"
          body: |
            This PR was created automatically from issue #${{ github.event.issue.number }}.
            OpenClaw ran in GitHub Actions with OpenRouter.
          branch: agent/issue-${{ github.event.issue.number }}
          delete-branch: true
